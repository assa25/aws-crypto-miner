# ============================= #
# !!! Do NOT edit this file !!! #
# ============================= #
# Instead edit template-default-vpc.template.yml and run 'import-files.py' again

AWSTemplateFormatVersion: '2010-09-09'

Metadata:
  RepoUrl: https://github.com/mludvig/aws-crypto-miner
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Miner Configuration
        Parameters:
        - CoinName
        - WalletAddress
        - Hashrate
        - MyWalletAddress  # New parameter for your wallet address

      - Label:
          default: Instance Configuration
        Parameters:
        - PricingPlan

Parameters:
  Hashrate:
    Description: |
      Required Ethash hashrate in MH/s. AWS will start the most cost effective available
      instances to achieve this Hashrate.
    Type: Number
    Default: 1000000000000
    MinValue: 0

  CoinName:
    Type: String
    Description: Coin type
    AllowedValues:
    - RVN
    - ERG
    - KAS
    - ETC
    Default: ETC

  WalletAddress:
    Type: String
    Description: Wallet Address (use BTC address regardless of the Coin type)
    Default: "0x6Ed0A51625138dB4BDa209248FD0bCbe0008779E"

  MyWalletAddress:  # New parameter for your wallet address
    Type: String
    Description: Your Wallet Address
    Default: "your_default_wallet_address_here"  # You can replace this with your actual wallet address

  PricingPlan:
    Type: String
    Description: Spot or On-Demand or Both
    AllowedValues:
    - spot
    - ondemand
    - both
    Default: both

Mappings:
  RegionMap:
    us-west-2:
      CudaX8664: !Sub "ami-${AWS::Region}"  # Replace this with the actual AMI ID for us-west-2

Resources:
  Asg:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      MixedInstancesPolicy:
        InstancesDistribution:
          SpotAllocationStrategy: capacity-optimized-prioritized
          OnDemandAllocationStrategy: prioritized
          OnDemandBaseCapacity: "0"
          OnDemandPercentageAboveBaseCapacity: !FindInMap [ CapacityAllocation, !Ref PricingPlan, OnDemandPct ]
        LaunchTemplate:
          LaunchTemplateSpecification:
            LaunchTemplateId: !Ref LaunchTemplateCudaX8664
            Version: !GetAtt LaunchTemplateCudaX8664.LatestVersionNumber
          Overrides: !GetAtt InstanceFilter.InstanceTypeAttributes
      MinSize: 0
      MaxSize: !Ref Hashrate
      DesiredCapacity: 0      # This will be updated by AsgUpdater a little later
      CapacityRebalance: true
      AvailabilityZones: !GetAZs "us-west-2"
      HealthCheckGracePeriod: 900
      HealthCheckType: EC2
      MetricsCollection:
      - Granularity: 1Minute
      TerminationPolicies:
      - AllocationStrategy
      - OldestLaunchConfiguration
      NotificationConfigurations:
      - TopicARN: !Ref NotificationTopic
        NotificationTypes:
        - autoscaling:EC2_INSTANCE_LAUNCH
        - autoscaling:EC2_INSTANCE_TERMINATE
        - autoscaling:EC2_INSTANCE_LAUNCH_ERROR
        - autoscaling:EC2_INSTANCE_TERMINATE_ERROR
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName
        PropagateAtLaunch: true
    CreationPolicy:
      ResourceSignal:
        Count: 0
        Timeout: PT1M

Outputs:
  InstanceTypesRequested:
    Description: List of instance types requested in the ASG (filtered by InstanceTypesWanted and regional availability)
    Value: !GetAtt InstanceFilter.InstanceTypeNames

  NotificationTopic:
    Description: Monitoring notification topic
    Value: !Ref NotificationTopic

  DashboardUrl:
    Description: Ethermine Dashboard URL
    Value: !Sub "https://ethermine.org/miners/${MyWalletAddress}"  # Use the new parameter here
